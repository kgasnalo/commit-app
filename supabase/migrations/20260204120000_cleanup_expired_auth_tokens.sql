-- =============================================================================
-- 期限切れ auth_tokens の自動クリーンアップ
-- =============================================================================
-- 毎日深夜3時(UTC)に、期限切れ後1時間以上経過したトークンを削除
--
-- 設計ポイント:
-- - 期限切れ直後ではなく1時間のバッファを設けることで、ログ調査の猶予を確保
-- - idx_auth_tokens_expires インデックスを使用して効率的に削除
-- =============================================================================

SELECT cron.schedule(
  'cleanup-expired-auth-tokens',
  '0 3 * * *',  -- 毎日 03:00 UTC (日本時間 12:00)
  $$
  DELETE FROM auth_tokens
  WHERE expires_at < NOW() - INTERVAL '1 hour';
  $$
);
